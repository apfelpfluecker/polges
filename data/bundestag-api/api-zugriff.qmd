# Zugriff auf die Bundestags-API

Einmal testen.

```{r}
# Simple Anleitung: https://www.r-bloggers.com/2020/02/r-api-tutorial-getting-started-with-apis-in-r/
# Laden von benötigten Paketen
library(httr)
library(jsonlite)

# GET-Request starten mit GET-Funktion und speichern in res
res = GET("http://api.open-notify.org/astros.json")

# Output ist der Link, Datum der Abfrage, Status (200 = alles gut), Kontent-Typ und Größe
res

# Der Inhalt ist raw Unicode, wir brauchen aber JSON, weil das das Standardformat für API-Daten ist. Deshalb packen wir das raw in einen character-Vektor
rawToChar(res$content)

# den character-Vektor können wir in eine JSON-strukturierte Liste packen
# fromJSON benötigt einen character Vektor mit JSON-Struktur
data = fromJSON(rawToChar(res$content))

```

Jetzt für den Bundestag

```{r}
# API-Key gültig bis Mai 2025
# https://dip.bundestag.de/%C3%BCber-dip/hilfe/api
api_key <- "I9FKdCn.hbfefNWCY336dL6x62vfwNKpoN2RZ1gp21"
url <- "https://search.dip.bundestag.de/api/v1/vorgang"

res <- GET(url = url, query = list(apikey = api_key))


```

und jetzt für Anträge

```{r}
# Key gültig bis 05/2025
api_key <- "I9FKdCn.hbfefNWCY336dL6x62vfwNKpoN2RZ1gp21"
url <- "https://search.dip.bundestag.de/api/v1/drucksache-text"

res <- GET(url, query = list (
  apikey = api_key,
  f.datum.start = "2017-09-24",
  f.datum.end = "2024-06-18",
  f.drucksachetyp = "Antrag"
))

data <- fromJSON(rawToChar(res$content))
ds <- as.data.frame(data)
ds
```

Antragsskript

```{r}
# API-Key (gültig bis 05/25)
api_key <- "I9FKdCn.hbfefNWCY336dL6x62vfwNKpoN2RZ1gp21"
# URL
url <- "https://search.dip.bundestag.de/api/v1/drucksache-text"

# Funktion für API-Anfrage
request <- function(key, url, start, end, type, cursor){
  res <- GET(url, query = list (
    apikey = key,
    f.datum.start = start,
    f.datum.end = end,
    f.drucksachetyp = type,
    cursor = cursor
  ))
  data <- fromJSON(rawToChar(res$content))
  ds <- as.data.frame(data)
  return(ds)
}

# erstes Ziehen nicht über die Funktion
res <- GET(url, query = list (
  apikey = api_key,
  f.datum.start = "2017-09-24",
  f.datum.end = "2024-06-18",
  f.drucksachetyp = "Antrag"
))
data <- fromJSON(rawToChar(res$content))
ds_gesamt <- as.data.frame(data)

# Cursor der 10. Entität abspeichern erstellen
cursor_alt <- ds_alt$cursor[10]
x <- TRUE

#Seite 13 und 20

while(x == TRUE){
  ds_neu <- request(api_key, url, start = "2017-09-24", end = "2024-06-18", type = "Antrag", cursor = cursor_alt)
  if (cursor_alt != ds_neu$cursor[10]) {
    ds_gesamt <- rbind(ds_gesamt,ds_neu)
    cursor_alt <- ds_neu$cursor[10]
  }
  else {
    x <- FALSE
  }
}

```
